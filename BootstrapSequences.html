<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Comparing Seuqences with Bootstrap and D3</title>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <!-- Bootstrap -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>

    <!-- Minified D3 -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>
  <style>
      body{
        font-family: "Lucida Console", Monaco, monospace;
      }
      div {
        display: block;
      }
      text {
        font-family: "Lucida Console", Monaco, monospace;
      }
      div[class*=container-fluid] {
        padding-top: 0px;
      }
      div[class*=parent] {
        padding-right: 0px;
        padding-left: 10px;
        padding-top: 5px;
      }
      div[class*=col-xs-11] {
        padding-right: 0px;
      }
      .axis path{
        stroke-width: 0px;
      }
      .axis line {
        stroke-width: 1px;
      }
      p {
        margin: 0;
        padding: 0;
        line-height: 14px;
      }
      .buttons {
        padding-left: 10px;
        padding-top: 10px;
      }
      .conRow {
        white-space: nowrap;
      }
      .adenine {
        background-color: dodgerblue;
      }
      .cytosine {
        background-color: orange;
      }
      .guanine {
        background-color: lightgreen;
      }
      .thymine {
        background-color: orchid;
      }
  </style>
    <body>
    <p class="buttons">
      <button type="button" class="btn btn-primary btn-sm" onclick="checkColor()">Color Code</button>
      <button type="button" class="btn btn-success btn-sm" onclick="sameChar()">Same Character</button>
      <button type="button" class="btn btn-info btn-sm" data-toggle="collapse" data-target=".conRow">Consensus</button>
    </p>
    <script>
        //Sample Data
        var data = [
          {"name": "Human", "value": "CGGTGGCCGTTATGTTCGTCATTCCGCCTAAACCCGCGGGGACATCGGACCTCGTACATTCTTCGAGCTATAGTCTTAGTTGGACATATGATCCGCTCCA"},
          {"name": "Dog", "value": "TGCCACACGACAGTTACCAAGGATGATACTGGACGGGCCATCTTGGCTTTTTAGTGCTGACTGAGCAGGCGGATATTGGTCAACTTTGAGAATGTGTGTA"},
          {"name": "Rat", "value": "AGCAGAATACCCAAGCGTGTCGAGCGGCTCCACCTCACCATGATAGCACGGCGTTTGAACCTCGGTCTGGGTAAGATGGAGGCGATGTATTGTGGAATTG"}
        ];
        //Creates array based on first sequence
        var firstSequence = data[0].value.split("");
        /* Base divs */ 
        //Creates div container to hold everything
        var container = d3.select("body")
                          .append("div")
                          .attr("class", "container-fluid");
        //Creates row for axis
        var axisRow   = container.append("div")
                          .attr("class", "row");
                        //Creates column to keep axis aligned with sequences
                        axisRow.append("div")
                          .attr("class", "col-xs-1");   
        var conString = findConsensus();

        var isColor = false;
        var isSame  = false;
        var uncollapsed = false;
        //Creates table
        createData();            
        /* Axis */
                        //Creates col for axis svg
        var svgCol    = axisRow.append("div")
                          .attr("class", "col-xs-11")
                          .attr("id", "area");
        var width     = parseInt(d3.select("#area").style("width"), 10);
                        //Appends svg to top row
        var svg       = svgCol.append("svg")
                          .attr("width", width)
                          .attr("height", 25);
                        //Horizontal scale
        var xScale    = d3.scaleLinear()
                          .domain([0, data[0].value.length])
                          .range([0, data[0].value.length * 8.42]);
                        //Creates axis
        var xAxis     = d3.axisTop(xScale);
                        //Calls the bottom axis
                        svg.append("g")
                          .attr("class", "axis")
                          .attr("transform", "translate(-5,25)")
                          .call(xAxis)
                          .select("text").remove();
                          
                        //Resizes svg and its elements to fit to window
                        d3.select(window).on('resize', resize);

        function findConsensus() {
                            var consensus = "";

                            //Counts each bases' occurrence
                            for( var base = 0; base < firstSequence.length; base++ ) {
                              var compare = [];
                              for( var seq = 0; seq < data.length; seq++ ) {
                                compare[seq] = data[seq].value.split("")[base];
                              }
                                var countBase = _.countBy( compare);
                                var numBases = [countBase.A, countBase.C, countBase.G, countBase.T];
                                var maximum = _.max( numBases );

                                //Checks there is only one maximum
                                var indexMax = _.indexOf( numBases, maximum );

                                //Appends most frequent base to consensus
                                if( indexMax == _.lastIndexOf( numBases, maximum ))
                                  switch( indexMax ) {
                                    case 0: consensus += "A"; break;
                                    case 1: consensus += "C"; break;
                                    case 2: consensus += "G"; break;
                                    case 3: consensus += "T"; break;
                                  }
                                else
                                  consensus += "?";
                              }
                            return consensus;
         }

        //Resizes axis with window
        function resize() {
                //Axis resize
                width = parseInt(d3.select("#area").style("width"), 10);
                
                        svgCol.selectAll("svg")
                          .attr("width", width);
                
                        container.selectAll(".parent")
                          .remove();
                
                        createData();
        }
        //Color codes sequences on button press
        function checkColor() {

                      if( isColor == true ) {
                        container.selectAll("#seqSpace")
                          .selectAll("text")
                          .data(function(d) { return d.value; } )
                          .attr("class", "sequence");
                        isColor = false;
                        return ;
                      };

                      if( isColor == false ) {
                        isColor = true;
                        colorize();
                        return ;
                      }
        };
        function colorize() {
                        container.selectAll("#seqSpace")
                          .selectAll("text")
                          .data(function(d) { return d.value; } )
                          .attr("class", function(d) {
                            if( d == "A")
                              return "adenine";
                            if( d == "C")
                              return "cytosine";
                            if( d == "G")
                              return "guanine";
                            if( d == "T")
                              return "thymine";
                          });
        }
        //Removes characters that do not match the first sequence on button press
        function sameChar() {
                  var box = 0;
                  var seqWidth = parseInt(d3.select('#seqSpace').style('width'), 10);
                  for( var end = 0; end != firstSequence.length - 1; box++ ) {
                    container.selectAll(".parent")
                      .filter(function(d, i) { return i === box; })
                      .selectAll("#seqSpace")
                      .selectAll("text")
                      .data(function(d) { return d.value; })
                      .text(function(d, i) {
                            if ( i < end )
                              return ;
                            if ( i != 0 && i == end )
                              return ;
                              //Truncates part that doesnt fit in window
                            if ( (i - end) * 8.42 < seqWidth - 4 * 8.42 ) {
                              //Saves last base to be entered
                              newEnd = i;
                              if( isSame == false ) {                       
                                if( d == firstSequence[i] )
                                  return d;
                                else
                                  return ".";
                              };
                              if( isSame == true )
                                return d;
                            }
                      }); 
                    end = newEnd;
                  };
                  isSame = !isSame;
                }         
        function createData() {
          var newCutOff = 0;
            /* Wrapping */
            //Creates a new row for sequences that were cut off
            for( var cutoff = 0; cutoff != firstSequence.length - 1; cutoff = newCutOff ) {
                //Creates row for data
                var parent    = container.append("div")
                                  .attr("class", "row parent");
                var row       = parent.selectAll("rows")
                                  .data(data)
                                  .enter()
                                  .append("div")
                                  .attr("class", "row resizer");
                //Creates row for consensus
                var conRow    = parent.append("div")
                                  .attr("class", "row collapse conRow resizer")
                                  .attr("id", "conRow");
                /* Names */
                //Appends name column
                var nameCol   = row.append("div")
                                  .attr("class", "col-xs-1") 
                                  .attr("id", "namePlate")
                                  .attr("data-toggle", "tooltip")
                                  .attr("title", function(d) { return d.name;})
                                  .append("p");
                //Finds the width of the name column
                var nameWidth = parseInt(d3.select('#namePlate').style('width'), 10);
                                //Enters the name
                                nameCol.selectAll("p")
                                  .data(function(d, i) { return d.name.split(""); })
                                  .enter()
                                  .append("text")
                                  .text(function(d, i) { 
                                    //Truncates if name is too long
                                    if( i * 8.42 >= nameWidth - 3 * 8.42 - 10) {
                                      if( (i - 1) * 8.42 >= nameWidth - 3 * 8.42 - 10) { return ""; }
                                      else { return "..."; } 
                                    };
                                    if ( i * 8.42 < nameWidth - 3 * 8.42 - 10) {
                                      return d; 
                                  }});
                /* Sequences */
                //Appends sequence columns
                var sequences = row.append("div")
                                  .attr("class", "col-xs-11")
                                  .attr("id", "seqSpace")
                                  .append("p");
                //Finds the width of the sequence column
                var seqWidth  = parseInt(d3.select('#seqSpace').style('width'), 10);
                                  //Enters the sequences
                                  sequences.selectAll("text")
                                  .data(function(d) { return d.value; })
                                  .enter()
                                  .append("text")
                                  .text(function(d, i) {
                                    //Does not enter same base twice                        
                                    if ( i < cutoff )
                                      return ;
                                    if ( i != 0 && i == cutoff )
                                      return ;
                                    //Truncates part that doesnt fit in window
                                    if ( (i - (cutoff ? cutoff : -1)) * 8.42 < seqWidth - 4 * 8.42 - 15) {
                                      //Saves last base to be entered
                                      newCutOff = i;
                                      //Checks for sameChar toggle
                                      if( isSame == false ) {
                                        return d;
                                      }
                                      if( isSame == true ) {                       
                                        if( d == firstSequence[i] )
                                          return d;
                                        else
                                          return ".";
                                      } 
                                    }})
                                  .attr("class", "sequence");
                                //Keeps cells colored through resize
                                if( isColor == true ) {
                                  colorize();
                                };

                /* Consensus */
                                //Writes "Consensus" name plate
                                conRow.append("div")
                                  .attr("class", "col-xs-1")
                                  .attr("data-toggle", "tooltip")
                                  .attr("id", "conName")
                                  .append("p")
                                  .append("text")
                                  .text(function() {
                                    //Truncates name if too long
                                    if( "Consensus".length * 8.42 > nameWidth )
                                      return "Consensus".substring(0, Math.floor(nameWidth / 8.42 ) - 3) + "...";
                                    else 
                                      return "Consensus";
                                  })
                                //Enters the consensus of the sequences
                                conRow.append("div")
                                  .attr("class", "col-xs-11")
                                  .append("p")
                                  .append("text")
                                  .text(conString.substring( cutoff ? cutoff + 1 : 0 , newCutOff + 1 ))
                                  .attr("class", "conText");
            }
        }
    </script>
  </body>
</html>
